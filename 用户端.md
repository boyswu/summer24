

# 人脸识别

## seetface6

[githubpython版][tensorflower/seetaFace6Python: 简单、快速搞定人脸识别应用，觉得有帮助，给个start吧！ (github.com)](https://github.com/tensorflower/seetaFace6Python)

最后下载完的结果

![想截图_2024070712002](C:\Users\boys\Desktop\24年暑假学习\assets\联想截图_20240707120023.png)

进行初始化seetaface

```python
#  seetaface初始化
self.init_mask = FACE_DETECT | FACERECOGNITION | LANDMARKER5
self.seetaFace = SeetaFace(self.init_mask)  # 初始化
```

代码里调用

```python
def request_face(self):
    """
    # 人脸识别
    :param frame: 用户的人脸图片
    :return:
    """
    _, frame = self.camera.read()  # 读取摄像头数据
    detect_result = self.seetaFace.Detect(frame)  # 人脸检测，返回人脸检测信息数组
    Feature = []
    if detect_result.size == 0:  # 当未检测到人脸时
        print("登录失败,请确认人脸是否录入!!!\n若已录入请面向摄像头切勿遮挡人脸!!!")
        QMbox = QMessageBox()
        QMbox.setWindowTitle("提示")
        QMbox.setText("登录失败,请确认人脸是否录入!!!\n若已录入请面向摄像头切勿遮挡人脸!!!")
        QMbox.exec_()
        return  # 函数返回，避免无用的运算时间
    for i in range(detect_result.size):  # 遍历每一个人的人脸数据
        face = detect_result.data[i].pos
        points = self.seetaFace.mark5(frame, face)  # 5点检测模型检测
        feature = self.seetaFace.Extract(frame, points)  # 在一张图片中提取指定人脸关键点区域的人脸的特征值
        feature = self.seetaFace.get_feature_numpy(feature)  # 获取feature的numpy表示数据
        Feature.append(feature)
    results = self.select_one_sql()
    for i in Feature:
        similar = []
        for j in results:
            if j[1] is not None:
                feature_sql = np.frombuffer(j[1], dtype=np.float32)
                similar1 = self.seetaFace.compare_feature_np(feature_sql, i)  # 使用numpy计算，比较人脸特征值相似度
                similar.append(similar1)
                # print(similar)
            if float(max(similar)) > 0.65:  # 当相似度大于0.65时
                # self.label.append(self.values[(similar.index(max(similar)))][0])  # 获取人名数据
                # # # print(self.values[(similar.index(max(similar1)))][3])   # 获取人学号
                # self.label.append(self.values[(similar.index(max(similar)))][3])
                # 打印出人名和学号
                print(results[(similar.index(max(similar)))][0], results[(similar.index(max(similar)))][3])
                print("存在")
            else:
                # print(results[(similar.index(max(similar)))][0], results[(similar.index(max(similar)))][3])
                print("不存在")
                return
```

## 人员注册

通过人脸识别将用户的面部关键点数据上传到数据库

```python
def register_system(self):
    """
    # 人脸识别
    :param frame: 用户的人脸图片
    :return:
    """
    _, frame = self.camera.read()  # 读取摄像头数据
    detect_result = self.seetaFace.Detect(frame)  # 人脸检测，返回人脸检测信息数组
    Feature = []
    if detect_result.size == 0:  # 当未检测到人脸时
        print("登录失败,请确认人脸是否录入!!!\n若已录入请面向摄像头切勿遮挡人脸!!!")
        QMbox = QMessageBox()
        QMbox.setWindowTitle("提示")
        QMbox.setText("登录失败,请确认人脸是否录入!!!\n若已录入请面向摄像头切勿遮挡人脸!!!")
        QMbox.exec_()
        return # 函数返回，避免无用的运算时间
    for i in range(detect_result.size):  # 遍历每一个人的人脸数据
        face = detect_result.data[i].pos
        points = self.seetaFace.mark5(frame, face)  # 5点检测模型检测
        feature = self.seetaFace.Extract(frame, points)  # 在一张图片中提取指定人脸关键点区域的人脸的特征值
        feature = self.seetaFace.get_feature_numpy(feature)  # 获取feature的numpy表示数据
        Feature.append(feature)

    db, cursor = self.connect_sql()
    sql = ("INSERT INTO name_feature(name, feature, place, id, sex, phone) "
           "VALUES (%s, %s, %s, %s, %s, %s)")
    try:
        print("开始插入数据", Feature)

        # 向数据库中插入数据
        data = feature.tostring()
        cursor.execute(sql, ('刘德华', data, '1', '230321111', '男', '1811151948'))
        db.commit()
        print("数据插入成功")
    except pymysql.Error as e:
        print(f"数据库插入失败: {e}")
        QMbox = QMessageBox()
        QMbox.setWindowTitle("提示")
        QMbox.setText("数据库插入失败: {}").format(e)
        QMbox.exec_()
    finally:
        cursor.close()
        db.close()
```

##登录

登录成功会进入用户借还书界面

```python
def log_in_system(self):
    # 登录系统
    self.request_face()  # 人脸识别
    self.new_page()

```

## 退出

```python
def log_out_system(self):
    self.camera_label.clear()  # 清空摄像头显示
    # 关闭摄像头
    self.camera.release()
    # 关闭窗口
    self.close()
```

## 界面

![想截图_2024070712253](C:\Users\boys\Desktop\24年暑假学习\assets\联想截图_20240707122537.png)



## 用户借书

### 思路

**先检查数据库有没有这本书，然后检查用户有没有借书未还，**通过人名和书的ID查询表里的最后一次还书时间，和借书时间，查看结果是否为空如果为空，还有还书时间不为空 表明用户未借过该书可以借书，然后将数据添加进表里（避免数据表为空的情况）。如果还书时间为空表明用户借书未还，不予借取。

```python
def borrow_book_func(self):
    if not self.path:
        QtWidgets.QMessageBox.warning(self, "警告", "请先选择一本书！")
        return
    result = self.recognize_figure.mode_match(self.path)
    if not result:
        QtWidgets.QMessageBox.warning(self, "警告", "识别失败！")
        return
    print(result)
    user_name = "user1"
    # 连接数据库
    db, cursor = self.connect_sql()
    #查询用户是否有借阅过该书未归还的书籍
    sql = """
    SELECT back_book_time 
    FROM borrowlist 
    WHERE user_br_book_id = '{}' AND user_name = '{}' 
    ORDER BY back_book_time DESC 
    LIMIT 1
    """.format(result, user_name)
    try:
        cursor.execute(sql)
        # 获取查询结果
        results = cursor.fetchall()
        print(results)
        #获取应还时间
        back_book_time = results
        # 如果查询结果不为空，则提示用户有借阅过该书
        # 如果查询结果为空，则提示用户没有借阅过该书
        if not results or back_book_time is not None:
            # 弹出提示框，确认是否借阅
            reply = QtWidgets.QMessageBox.question(self, '提示', '确认借阅吗？', QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No,
                                                   QtWidgets.QMessageBox.No)
            if reply == QtWidgets.QMessageBox.No:
                return
            if reply == QtWidgets.QMessageBox.Yes:
                # 连接数据库
                sql = "SELECT * FROM book_info WHERE book_cm_isbn = %s"
                try:
                    cursor.execute(sql, result)
                    # db.commit()
                    # 获取查询结果
                    # 如果查询结果为空，则提示用户没有该书
                    results = cursor.fetchall()
                    if not results:
                        QtWidgets.QMessageBox.warning(self, "警告", "没有该书！")
                        return
                    else:
                        user_id = 1
                        # 获取用户名
                        user_name = "user1"
                        # 获取书名
                        bookname = results[0][0]
                        print(" bookname", bookname)
                        # 获取书籍id
                        book_id = results[0][2]
                        print(" book_id", book_id)
                        book_object = "文学"

                        br_book_time = datetime.datetime.now()
                        # 获取应还时间
                        back_book_time = ""
                        # 获取书籍对象
                        # 借阅书籍
                        sql = ("INSERT INTO borrowlist (user_id, user_name, user_br_book_id, br_book_time,"
                               " back_book_time, user_br_book_name,book_object)"
                               " VALUES ('{}', '{}', '{}','{}', '{}', '{}', '{}')").format(user_id, user_name,
                                                                                           book_id,br_book_time,
                                                                                           back_book_time,
                                                                                           bookname, book_object)
                        try:
                            cursor.execute(sql)
                            db.commit()
                            QtWidgets.QMessageBox.information(self, "提示", "借阅成功！")
                        except Exception as e:
                            # 回滚
                            print(e)
                            db.rollback()
                            QtWidgets.QMessageBox.warning(self, "警告", "借阅失败！")
                            return

                except Exception as e:
                    # 回滚
                    print(e)
                    db.rollback()
                    QtWidgets.QMessageBox.warning(self, "警告", "借阅失败!!")
                    return
        else:
            QtWidgets.QMessageBox.warning(self, "警告", "该书已借阅！")
            return
    except Exception as e:
        # 回滚
        print(e)
        db.rollback()
        QtWidgets.QMessageBox.warning(self, "警告", "借阅失败!!")
        return
        # 关闭数据库连接
    finally:
        cursor.close()
        db.close()
        return
```

## 用户还书

### 思路

**查询用户有没有借过该书：**通过人名和书的ID查询表里的借书时间和还书时间，结果如果为空说明该用户未借过该书，如果结果都不为空说明用户已经还过该书。如果最后一次还书时间为空，则执行程序连接数据库添加进还书时间。

```python
def return_book_func(self):
    if not self.path:
        QtWidgets.QMessageBox.warning(self, "警告", "请先选择一本书！")
        return
    result = self.recognize_figure.mode_match(self.path)
    if not result:
        QtWidgets.QMessageBox.warning(self, "警告", "识别失败！")
        return
    print(result)
    user_name = "user1"
    # 连接数据库
    db, cursor = self.connect_sql()
    # 查询数据表里的数据
    sql = "SELECT back_book_time FROM borrowlist WHERE user_br_book_id = '{}'AND user_name = '{}'".format(result, user_name)
    try:
        cursor.execute(sql)
        # 获取查询结果
        results = cursor.fetchall()
        # 获取应还时间
        back_book_time = results[4]
        # 如果查询结果为空，则提示用户没有借阅该书
        if not results:
            QtWidgets.QMessageBox.warning(self, "警告", "没有借阅该书！")
            return
        if back_book_time is not None:
            QtWidgets.QMessageBox.warning(self, "警告", "该书已归还！")
            return
        if back_book_time is None:
            # 归还书籍
            # 弹出提示框，确认是否归还
            reply = QtWidgets.QMessageBox.question(self, '提示', '确认归还吗？', QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No,
                                                   QtWidgets.QMessageBox.No)
            if reply == QtWidgets.QMessageBox.Yes:
                # 连接数据库
                db = pymysql.connect(host=host, user=user, passwd=passwd, db=db2, charset='utf8')
                cursor = db.cursor()
                # 更改数据表中的数据
                sql = "UPDATE borrowlist SET back_book_time = %s WHEREuser_br_book_id = {} AND user_name = {}".format(result, user_name)
                try:

                    back_book_time = datetime.datetime.now()
                    cursor.execute(sql, back_book_time)
                    db.commit()
                    QtWidgets.QMessageBox.information(self, "提示", "归还成功！")
                except Exception as e:
                    # 回滚
                    print(e)
                    db.rollback()
                    QtWidgets.QMessageBox.warning(self, "警告", "归还失败！")
                    return
            else:
                return
    except Exception as e:
        # 回滚
        print(e)
        db.rollback()
        QtWidgets.QMessageBox.warning(self, "警告", "归还失败!!")
        return
        # 关闭数据库连接
    finally:
        cursor.close()
        db.close()
        return
```

##界面 

![72032726410](C:\Users\boys\Desktop\24年暑假学习\assets\1720327264102.png)



# github地址

<[boyswu/summer24 (github.com)](https://github.com/boyswu/summer24)>

